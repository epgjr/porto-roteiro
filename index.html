<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Porto ‚Ä¢ Mar√ßo 2026</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --porto-blue: #1a4d7a;
            --porto-gold: #d4af37;
            --porto-terracotta: #c9574d;
            --porto-cream: #f8f6f1;
            --porto-dark: #2a2a2a;
            --porto-stone: #8b8378;
            --porto-green: #4a8b5c;
            --shadow-soft: 0 4px 24px rgba(26, 77, 122, 0.08);
            --shadow-medium: 0 8px 32px rgba(26, 77, 122, 0.12);
        }
        
        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: linear-gradient(135deg, #f8f6f1 0%, #e8e3d8 100%);
            color: var(--porto-dark);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, var(--porto-blue) 0%, #2a5c8f 100%);
            color: white;
            padding: 2rem 1.5rem;
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="azulejo" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse"><rect fill="none" width="100" height="100"/><path d="M50,0 L100,50 L50,100 L0,50 Z" fill="rgba(255,255,255,0.03)" stroke="rgba(255,255,255,0.08)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23azulejo)"/></svg>');
            opacity: 0.4;
        }
        
        .header-content {
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 400;
        }
        
        .header-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }
        
        .collapsible-section {
            background: white;
            border-radius: 16px;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-soft);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .collapsible-section.hidden {
            display: none;
        }
        
        .section-content {
            padding: 1.5rem;
        }
        
        .days-nav {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            -webkit-overflow-scrolling: touch;
        }
        
        .day-btn {
            background: white;
            border: 2px solid var(--porto-blue);
            color: var(--porto-blue);
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: var(--shadow-soft);
            font-family: 'DM Sans', sans-serif;
        }
        
        .day-btn:hover {
            background: var(--porto-blue);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .day-btn.active {
            background: var(--porto-blue);
            color: white;
            box-shadow: var(--shadow-medium);
        }
        
        .edit-btn {
            background: var(--porto-green);
            border: 2px solid var(--porto-green);
            color: white;
            padding: 0.75rem 1.1rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: var(--shadow-soft);
            font-family: 'DM Sans', sans-serif;
            flex-shrink: 0;
        }
        
        .edit-btn:hover {
            background: #3d7349;
            border-color: #3d7349;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .edit-btn.editing {
            background: var(--porto-terracotta);
            border-color: var(--porto-terracotta);
            animation: pulse-red 1.5s infinite;
        }
        
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(201, 87, 77, 0.5); }
            50% { box-shadow: 0 0 0 8px rgba(201, 87, 77, 0); }
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        
        @media (min-width: 968px) {
            .content-grid {
                grid-template-columns: 450px 1fr;
            }
        }
        
        .places-list {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-soft);
            height: fit-content;
        }
        
        .day-title-container {
            margin-bottom: 1.5rem;
        }
        
        .day-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            color: var(--porto-blue);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .day-title-edit {
            width: 100%;
            font-family: 'Playfair Display', serif;
            font-size: 1.6rem;
            color: var(--porto-blue);
            padding: 0.75rem;
            border: 2px solid var(--porto-gold);
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .day-title-edit:focus {
            outline: none;
            border-color: var(--porto-blue);
        }
        
        .place-card {
            border-left: 3px solid var(--porto-gold);
            padding: 1rem 0 1rem 1rem;
            margin-bottom: 1.5rem;
            position: relative;
            transition: all 0.3s ease;
            background: white;
            border-radius: 0 8px 8px 0;
        }
        
        .place-card.dragging {
            opacity: 0.4;
            transform: rotate(2deg);
        }
        
        .place-card.visited {
            opacity: 0.6;
            border-left-color: var(--porto-green);
        }
        
        .place-card:hover {
            border-left-color: var(--porto-terracotta);
            background: rgba(212, 175, 55, 0.05);
        }
        
        .drag-handle {
            position: absolute;
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
            cursor: grab;
            font-size: 1.3rem;
            color: var(--porto-stone);
            opacity: 0;
            transition: opacity 0.3s;
            user-select: none;
        }
        
        .place-card:hover .drag-handle {
            opacity: 0.7;
        }
        
        .drag-handle:hover {
            opacity: 1 !important;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
        
        .place-number {
            position: absolute;
            left: -14px;
            top: 1rem;
            background: var(--porto-gold);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            box-shadow: var(--shadow-soft);
        }
        
        .place-card.visited .place-number {
            background: var(--porto-green);
        }
        
        .place-header {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .checkbox-container {
            position: relative;
            cursor: pointer;
            user-select: none;
            flex-shrink: 0;
        }
        
        .checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }
        
        .checkmark {
            display: block;
            width: 24px;
            height: 24px;
            background-color: white;
            border: 2px solid var(--porto-blue);
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .checkbox-container:hover .checkmark {
            background-color: var(--porto-cream);
        }
        
        .checkbox-container input:checked ~ .checkmark {
            background-color: var(--porto-green);
            border-color: var(--porto-green);
        }
        
        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
            left: 7px;
            top: 3px;
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        .checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }
        
        .place-info {
            flex: 1;
        }
        
        .place-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--porto-dark);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .place-time {
            font-size: 0.9rem;
            color: var(--porto-stone);
            margin-bottom: 0.5rem;
        }
        
        .place-notes {
            font-size: 0.9rem;
            color: var(--porto-dark);
            line-height: 1.5;
            opacity: 0.85;
            margin-bottom: 0.75rem;
        }
        
        .place-comments {
            margin-top: 0.75rem;
        }
        
        .comments-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--porto-blue);
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .comments-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--porto-cream);
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 60px;
            transition: all 0.3s ease;
        }
        
        .comments-input:focus {
            outline: none;
            border-color: var(--porto-blue);
            background: rgba(26, 77, 122, 0.02);
        }
        
        .icon {
            font-style: normal;
            font-size: 1.1rem;
        }
        
        .map-container {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
            height: 600px;
            position: sticky;
            top: 2rem;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.95rem;
        }
        
        .btn-primary {
            background: var(--porto-blue);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2a5c8f;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--porto-gold);
            color: white;
        }
        
        .btn-secondary:hover {
            background: #c29d2f;
            transform: translateY(-2px);
        }
        
        .btn-tertiary {
            background: white;
            color: var(--porto-blue);
            border: 2px solid var(--porto-blue);
        }
        
        .btn-tertiary:hover {
            background: var(--porto-cream);
        }
        
        .btn-danger {
            background: var(--porto-terracotta);
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }
        
        .btn-danger:hover {
            background: #a84438;
        }
        
        .btn-add {
            background: var(--porto-green);
            color: white;
            margin-top: 1rem;
            width: 100%;
        }
        
        .btn-add:hover {
            background: #3d7349;
            transform: translateY(-2px);
        }

        .edit-action-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .edit-day-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .btn-add-small {
            background: var(--porto-green);
            color: white;
            flex: 1;
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
        }

        .btn-add-small:hover {
            background: #3d7349;
            transform: translateY(-2px);
        }

        .btn-conclude {
            background: var(--porto-blue);
            color: white;
            flex: 1;
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
        }

        .btn-conclude:hover {
            background: #2a5c8f;
            transform: translateY(-2px);
        }

        .btn-add-day {
            background: var(--porto-gold);
            color: white;
            flex: 1;
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
        }

        .btn-add-day:hover {
            background: #c29d2f;
            transform: translateY(-2px);
        }

        .btn-delete-day {
            background: var(--porto-terracotta);
            color: white;
            flex: 1;
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
        }

        .btn-delete-day:hover {
            background: #a84438;
            transform: translateY(-2px);
        }
        
        .edit-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }
        
        textarea, input[type="text"] {
            font-family: 'DM Sans', sans-serif;
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--porto-stone);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }
        
        textarea:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--porto-blue);
        }
        
        .edit-place {
            background: var(--porto-cream);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 2px dashed var(--porto-stone);
        }
        
        .edit-place h4 {
            color: var(--porto-blue);
            margin-bottom: 1rem;
        }
        
        .footer {
            text-align: center;
            padding: 3rem 1.5rem;
            color: var(--porto-stone);
            font-size: 0.9rem;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .place-card {
            animation: fadeIn 0.4s ease backwards;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div>
                <h1>Porto ‚Ä¢ Mar√ßo 2026</h1>
                <p class="subtitle">5 dias explorando a cidade invicta</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="days-nav" id="daysNav"></div>

        <div class="content-grid">
            <div class="places-list" id="placesList"></div>

            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>‚úàÔ∏è Feito com ‚ù§Ô∏è para sua viagem a Porto</p>
        <p style="margin-top: 0.5rem; font-size: 0.8rem;">Roteiro criado com Claude AI ‚Ä¢ Mar√ßo 2026 üó∫Ô∏è</p>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
// Inicializar Firebase
firebase.initializeApp({
  apiKey: "AIzaSyALD-Nrc-dYfRLFBi-vuuEW06tpm3n3u1g",
  authDomain: "porto-roteiro.firebaseapp.com",
  databaseURL: "https://porto-roteiro-default-rtdb.firebaseio.com",
  projectId: "porto-roteiro",
  storageBucket: "porto-roteiro.firebasestorage.app",
  messagingSenderId: "886950722259",
  appId: "1:886950722259:web:791fb9fe863892056c7226"
});

const database = firebase.database();
const itineraryRef = database.ref('itinerary');

// Dados do roteiro padr√£o
const defaultItinerary = {
    days: [
        {
            id: 1,
            title: "Chegada & Centro Hist√≥rico",
            places: [
                { name: "Livraria Lello", lat: 41.1469055, lng: -8.6147746, time: "10:00", duration: 45, notes: "Uma das livrarias mais bonitas do mundo! Reserve online (‚Ç¨10, dedut√≠vel em compras). Chegue cedo para evitar multid√µes.", icon: "üìö", visited: false, comments: "", transportMode: "WALKING" },
                { name: "Torre dos Cl√©rigos", lat: 41.1456705, lng: -8.6145977, time: "11:30", duration: 90, notes: "Suba os 240 degraus para vista panor√¢mica espetacular! Ticket ~‚Ç¨8-10. A igreja barroca tamb√©m √© linda.", icon: "üóº", visited: false, comments: "", transportMode: "WALKING" },
                { name: "Majestic Caf√©", lat: 41.1472382, lng: -8.6065795, time: "13:30", duration: 60, notes: "Almo√ßo no caf√© hist√≥rico art nouveau (1921). Experimente a Rabanada famosa e caf√© com m√∫sica ao vivo!", icon: "‚òï", visited: false, comments: "", transportMode: "WALKING" },
                { name: "S√© do Porto (Catedral)", lat: 41.1428531, lng: -8.6111165, time: "15:30", duration: 60, notes: "Catedral do s√©culo XII com claustro g√≥tico e azulejos portugueses. Vista linda do terra√ßo. Entrada: ‚Ç¨4", icon: "‚õ™", visited: false, comments: "", transportMode: "WALKING" },
                { name: "The Door", lat: 41.1441961, lng: -8.616688, time: "19:00", duration: 120, notes: "‚≠ê JANTAR: Intimista e excelente! Reserve! Beef Tagliata e vieiras imperd√≠veis. Sangria top.", icon: "üçΩÔ∏è", visited: false, comments: "", transportMode: "WALKING" }
            ]
        },
        {
            id: 2,
            title: "Vale do Douro & Vin√≠colas",
            places: [
                { name: "Quinta do Seixo (Sandeman)", lat: 41.1681615, lng: -7.5548695, time: "10:30", duration: 180, notes: "üç∑ Vista ESPETACULAR do Douro! Tour + degusta√ß√£o 5 vinhos (‚Ç¨32). Reserve online. Inclui almo√ßo opcional. Paisagem de cinema!", icon: "üçá", visited: false, comments: "", transportMode: "DRIVING" },
                { name: "Quinta do P√¥pa", lat: 41.1536111, lng: -7.6011111, time: "14:30", duration: 120, notes: "Segunda vin√≠cola com vistas incr√≠veis! Pet-friendly. Op√ß√£o de picnic no terra√ßo. Staff super atencioso. Fecha seg/ter.", icon: "üç∑", visited: false, comments: "", transportMode: "DRIVING" },
                { name: "Bota & Bira", lat: 41.1424129, lng: -8.6158059, time: "20:00", duration: 120, notes: "‚≠ê JANTAR: Especialista em carnes! Ribeye e Chorizo Rice s√£o obrigat√≥rios. Aconchegante. Reserve! Fecha dom/seg.", icon: "ü•©", visited: false, comments: "", transportMode: "DRIVING" }
            ]
        },
        {
            id: 3,
            title: "Ribeira & Rio Douro",
            places: [
                { name: "Mercado do Bolh√£o", lat: 41.1493855, lng: -8.6071175, time: "09:30", duration: 90, notes: "Mercado tradicional lindo e limpo! Produtos locais, queijos, bacalhau. √ìtimo para brunch. Restaurantes no piso superior.", icon: "ü•ñ", visited: false, comments: "", transportMode: "WALKING" },
                { name: "Pal√°cio da Bolsa", lat: 41.1413772, lng: -8.6156725, time: "11:30", duration: 90, notes: "Pal√°cio neocl√°ssico - UNESCO. A Sala √Årabe inspirada na Alhambra √© DESLUMBRANTE! Tour guiado obrigat√≥rio. Reserve online!", icon: "üèõÔ∏è", visited: false, comments: "", transportMode: "WALKING" },
                { name: "Ribeira", lat: 41.1432682, lng: -8.6103135, time: "14:00", duration: 120, notes: "Almo√ßo livre + passeio pelo bairro mais fotog√™nico! Casas coloridas. Considere passeio de barco 6 pontes (‚Ç¨20, 1h).", icon: "üèòÔ∏è", visited: false, comments: "", transportMode: "WALKING" },
                { name: "Ponte Dom Lu√≠s I", lat: 41.1399589, lng: -8.6094485, time: "17:00", duration: 60, notes: "Atravesse a p√© (n√≠vel superior). Vista espetacular! Constru√≠da em 1886. Do outro lado h√° caves de vinho. Ideal ao p√¥r do sol!", icon: "üåâ", visited: false, comments: "", transportMode: "WALKING" },
                { name: "Casa D'oro", lat: 41.1479419, lng: -8.6427335, time: "19:30", duration: 120, notes: "‚≠ê JANTAR: Italiano com terra√ßo INCR√çVEL sobre o Douro! Tagliatelle camar√£o e pizza Diavola. Chegue cedo pro terra√ßo!", icon: "üçù", visited: false, comments: "", transportMode: "WALKING" }
            ]
        },
        {
            id: 4,
            title: "Jardins & Fine Dining",
            places: [
                { name: "Jardins do Pal√°cio de Cristal", lat: 41.1482682, lng: -8.6255165, time: "10:00", duration: 150, notes: "Jardins lindos com vista panor√¢mica do Douro e cidade! Pav√µes soltos, v√°rios mirantes. Caminhada rom√¢ntica. Entrada gratuita!", icon: "üå≥", visited: false, comments: "", transportMode: "WALKING" },
                { name: "Em Canto", lat: 41.144569, lng: -8.6120973, time: "13:00", duration: 90, notes: "Almo√ßo tranquilo longe do turismo. √ìtimo atendimento, comida portuguesa tradicional bem feita. Ambiente acolhedor. Fecha domingo.", icon: "üç¥", visited: false, comments: "", transportMode: "WALKING" },
                { name: "Pedro Lemos", lat: 41.1480641, lng: -8.6500361, time: "19:30", duration: 180, notes: "‚≠ê‚≠ê JANTAR MICHELIN: 1 estrela √† beira do Douro! Menu degusta√ß√£o 7 momentos (‚Ç¨180). RESERVE COM MUITA ANTECED√äNCIA! Sofisticado mas acolhedor. Fecha dom/seg/ter.", icon: "üåü", visited: false, comments: "", transportMode: "WALKING" }
            ]
        },
        {
            id: 5,
            title: "√öltimo Dia & Despedida",
            places: [
                { name: "Igreja dos Cl√©rigos", lat: 41.1458838, lng: -8.6139451, time: "10:00", duration: 60, notes: "Igreja barroca linda. √Ä noite tem show de luzes especial (verifique hor√°rios). Peaceful e fotog√™nica.", icon: "‚õ™", visited: false, comments: "", transportMode: "WALKING" },
                { name: "Ribeira - Compras", lat: 41.1432682, lng: -8.6103135, time: "12:00", duration: 120, notes: "√öltimo almo√ßo na Ribeira! Compre lembran√ßas: vinho do Porto, azulejos, sardinhas em lata, produtos de corti√ßa. Explore lojinhas.", icon: "üõçÔ∏è", visited: false, comments: "", transportMode: "WALKING" },
                { name: "A Despensa", lat: 41.1472496, lng: -8.613547, time: "19:00", duration: 120, notes: "‚≠ê JANTAR DE DESPEDIDA: Italiano excepcional! Burrata imperd√≠vel, lasanha com bechamel, fusili pesto am√™ndoas. √ìtimo custo-benef√≠cio. Reserve! Fecha seg.", icon: "üçï", visited: false, comments: "", transportMode: "WALKING" }
            ]
        }
    ]
};

let itinerary = JSON.parse(JSON.stringify(defaultItinerary));
let currentDay = 0;
let map;
let markers = [];
let editMode = false;
let draggedElement = null;
let draggedIndex = null;
let directionsRenderer = null;
let directionsService = null;


// ========== FIREBASE ==========
function saveItinerary() {
    itineraryRef.set(itinerary);
    localStorage.setItem('portoItinerary', JSON.stringify(itinerary));
}

// ========== INICIALIZA√á√ÉO ==========
itineraryRef.on('value', (snapshot) => {
    const data = snapshot.val();
    if (data && data.days && data.days.length > 0) {
        itinerary = data;
    } else {
        itinerary = JSON.parse(JSON.stringify(defaultItinerary));
        itineraryRef.set(itinerary);
    }
    if (map) {
        renderDaysNav();
        showDay(currentDay);
    }
});

// ========== GOOGLE MAPS ==========
function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 13,
        center: { lat: 41.1579, lng: -8.6291 },
        styles: [
            { featureType: "water", elementType: "geometry", stylers: [{ color: "#a4cce6" }] },
            { featureType: "landscape", elementType: "geometry", stylers: [{ color: "#f5f5f2" }] }
        ]
    });
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
        suppressMarkers: true,
        polylineOptions: {
            strokeColor: '#1a4d7a',
            strokeWeight: 4,
            strokeOpacity: 0.6
        }
    });
    directionsRenderer.setMap(map);

    // Aguardar Firebase carregar dados
    const checkData = setInterval(() => {
        if (itinerary && itinerary.days) {
            clearInterval(checkData);
            renderDaysNav();
            showDay(0);
        }
    }, 100);
}

// ========== NAVEGA√á√ÉO ==========
function renderDaysNav() {
    const nav = document.getElementById('daysNav');
    const editButton = `<button class="edit-btn ${editMode ? 'editing' : ''}" onclick="toggleEditMode()" title="${editMode ? 'Concluir edi√ß√£o' : 'Ajustar roteiro'}">‚öôÔ∏è</button>`;
    const dayButtons = itinerary.days.map((day, index) =>
        `<button class="day-btn ${index === currentDay ? 'active' : ''}" onclick="showDay(${index})">
            Dia ${day.id}: ${day.title}
        </button>`
    ).join('');
    nav.innerHTML = editButton + dayButtons;
}

// ========== MOSTRAR DIA ==========
function showDay(dayIndex) {
    currentDay = dayIndex;
    const day = itinerary.days[dayIndex];
    renderDaysNav();

    const list = document.getElementById('placesList');

    if (editMode) {
        const placesHtml = day.places && day.places.length > 0
            ? day.places.map((place, index) => renderPlaceEdit(place, index, dayIndex)).join('')
            : '<p style="color: var(--porto-stone); font-style: italic; padding: 1rem 0;">Nenhum local ainda. Adicione um local abaixo!</p>';

        list.innerHTML = `
            <div class="day-title-container">
                <input type="text" class="day-title-edit" value="${day.title}"
                       onchange="updateDayTitle(${dayIndex}, this.value)"
                       placeholder="Nome do dia">
            </div>
            <div id="editPlacesContainer">
                ${placesHtml}
            </div>
            <div class="edit-action-buttons">
                <button class="btn btn-add-small" onclick="addNewPlace(${dayIndex})">‚ûï Adicionar Local</button>
                <button class="btn btn-conclude" onclick="concludeEdit()">‚úÖ Concluir</button>
            </div>
            <div class="edit-day-buttons">
                <button class="btn btn-add-day" onclick="addNewDay()">üìÖ Adicionar Dia</button>
                <button class="btn btn-delete-day" onclick="deleteDay(${dayIndex})">üóëÔ∏è Excluir Dia</button>
            </div>
        `;
        setupDragAndDropEdit(dayIndex);
        setTimeout(() => {
            if (day.places) {
                day.places.forEach((place, index) => {
                    setupAutocomplete(dayIndex, index);
                });
            }
        }, 300);
    } else {
        list.innerHTML = `
            <h2 class="day-title">Dia ${day.id}: ${day.title}</h2>
            <div id="placesContainer">
                ${day.places.map((place, index) => renderPlace(place, index, dayIndex)).join('')}
            </div>
        `;
        // Calcular dist√¢ncias ap√≥s render
        setTimeout(() => {
            day.places.forEach((place, index) => {
                if (index > 0) calculateRoute(dayIndex, index);
            });
        }, 500);
    }

    updateMap(day.places);
}

// ========== RENDERIZAR LUGAR (modo normal) ==========
function renderPlace(place, index, dayIndex) {
    const routeHtml = index > 0 ? `
        <div class="route-info" id="route-${dayIndex}-${index}">
            <span class="route-loading">‚è≥ Calculando...</span>
            <select class="transport-selector"
                    onchange="changeTransport(${dayIndex}, ${index}, this.value)">
                <option value="WALKING"  ${(place.transportMode||'WALKING')==='WALKING'  ? 'selected':''}>üö∂ A p√©</option>
                <option value="DRIVING"  ${(place.transportMode||'WALKING')==='DRIVING'  ? 'selected':''}>üöó Carro</option>
                <option value="TRANSIT"  ${(place.transportMode||'WALKING')==='TRANSIT'  ? 'selected':''}>üöá Metro/Bus</option>
                <option value="BICYCLING"${(place.transportMode||'WALKING')==='BICYCLING'? 'selected':''}>üö≤ Bicicleta</option>
            </select>
        </div>
    ` : '';

    return `
        ${routeHtml}
        <div class="place-card ${place.visited ? 'visited' : ''}">
            <div class="place-number">${index + 1}</div>
            <div class="place-header">
                <label class="checkbox-container">
                    <input type="checkbox" ${place.visited ? 'checked' : ''}
                           onchange="toggleVisited(${dayIndex}, ${index}, this.checked)">
                    <span class="checkmark"></span>
                </label>
                <div class="place-info">
                    <div class="place-name">
                        <span class="icon">${place.icon}</span>
                        ${place.name}
                    </div>
                    <div class="place-time">üïê ${place.time} ‚Ä¢ ${place.duration}min</div>
                    <div class="place-notes">${place.notes}</div>
                    <div class="place-comments">
                        <label class="comments-label">üí≠ Suas anota√ß√µes:</label>
                        <textarea class="comments-input"
                                  placeholder="Adicione suas dicas e observa√ß√µes aqui..."
                                  onchange="updateComments(${dayIndex}, ${index}, this.value)">${place.comments || ''}</textarea>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ========== RENDERIZAR LUGAR (modo edi√ß√£o) ==========
function renderPlaceEdit(place, index, dayIndex) {
    return `
        <div class="edit-place" draggable="true" data-index="${index}">
            <h4>üìç Lugar ${index + 1}
                <span style="font-size:0.8rem; color:var(--porto-stone); font-weight:400; margin-left:10px;">
                    ‚ãÆ‚ãÆ Arraste para reordenar
                </span>
            </h4>
            <input type="text"
                   id="place-name-${dayIndex}-${index}"
                   value="${place.name}"
                   placeholder="Digite o nome do lugar (use o autocomplete)"
                   onchange="updatePlace(${dayIndex}, ${index}, 'name', this.value)"
                   style="border: 2px solid var(--porto-gold);">
            <input type="text" value="${place.time}"
                   onchange="updatePlace(${dayIndex}, ${index}, 'time', this.value)"
                   placeholder="Hor√°rio (ex: 10:00)">
            <input type="text" value="${place.duration}"
                   onchange="updatePlace(${dayIndex}, ${index}, 'duration', parseInt(this.value))"
                   placeholder="Dura√ß√£o em minutos (ex: 45)">
            <input type="text" value="${place.icon}"
                   onchange="updatePlace(${dayIndex}, ${index}, 'icon', this.value)"
                   placeholder="Emoji (ex: üçï)"
                   style="width: 100px;">
            <textarea onchange="updatePlace(${dayIndex}, ${index}, 'notes', this.value)"
                      placeholder="Notas e dicas">${place.notes}</textarea>
            <button class="btn btn-danger" onclick="deletePlace(${dayIndex}, ${index})">üóëÔ∏è Remover Local</button>
        </div>
    `;
}

// ========== AUTOCOMPLETE ==========
function setupAutocomplete(dayIndex, placeIndex) {
    const input = document.getElementById(`place-name-${dayIndex}-${placeIndex}`);
    if (!input || !google || !google.maps || !google.maps.places) return;

    const autocomplete = new google.maps.places.Autocomplete(input, {
        fields: ['name', 'geometry', 'formatted_address'],
        types: ['establishment', 'geocode']
    });

    google.maps.event.addListener(autocomplete, 'place_changed', function() {
        const place = autocomplete.getPlace();
        if (place && place.geometry && place.geometry.location) {
            const name = place.name || place.formatted_address;
            const lat  = place.geometry.location.lat();
            const lng  = place.geometry.location.lng();

            itinerary.days[dayIndex].places[placeIndex].name = name;
            itinerary.days[dayIndex].places[placeIndex].lat  = lat;
            itinerary.days[dayIndex].places[placeIndex].lng  = lng;

            input.value = name;
            saveItinerary();
            updateMap(itinerary.days[dayIndex].places);
        }
    });
}

// ========== CALCULAR ROTA ==========
function calculateRoute(dayIndex, placeIndex) {
    const day   = itinerary.days[dayIndex];
    const curr  = day.places[placeIndex];
    const prev  = day.places[placeIndex - 1];
    const mode  = curr.transportMode || 'WALKING';
    const divId = `route-${dayIndex}-${placeIndex}`;
    const div   = document.getElementById(divId);
    if (!div || !directionsService) return;

    directionsService.route({
        origin:      { lat: prev.lat, lng: prev.lng },
        destination: { lat: curr.lat, lng: curr.lng },
        travelMode:  google.maps.TravelMode[mode]
    }, (result, status) => {
        if (status === 'OK') {
            const leg  = result.routes[0].legs[0];
            div.innerHTML = `
                <div class="route-details">
                    <span class="route-distance">üìè ${leg.distance.text}</span>
                    <span class="route-duration">‚è±Ô∏è ${leg.duration.text}</span>
                </div>
                <select class="transport-selector"
                        onchange="changeTransport(${dayIndex}, ${placeIndex}, this.value)">
                    <option value="WALKING"  ${mode==='WALKING'  ?'selected':''}>üö∂ A p√©</option>
                    <option value="DRIVING"  ${mode==='DRIVING'  ?'selected':''}>üöó Carro</option>
                    <option value="TRANSIT"  ${mode==='TRANSIT'  ?'selected':''}>üöá Metro/Bus</option>
                    <option value="BICYCLING"${mode==='BICYCLING'?'selected':''}>üö≤ Bicicleta</option>
                </select>
            `;
        } else {
            div.innerHTML = `
                <div class="route-details">
                    <span style="color:var(--porto-stone); font-size:0.85rem;">Rota n√£o dispon√≠vel</span>
                </div>
                <select class="transport-selector"
                        onchange="changeTransport(${dayIndex}, ${placeIndex}, this.value)">
                    <option value="WALKING"  ${mode==='WALKING'  ?'selected':''}>üö∂ A p√©</option>
                    <option value="DRIVING"  ${mode==='DRIVING'  ?'selected':''}>üöó Carro</option>
                    <option value="TRANSIT"  ${mode==='TRANSIT'  ?'selected':''}>üöá Metro/Bus</option>
                    <option value="BICYCLING"${mode==='BICYCLING'?'selected':''}>üö≤ Bicicleta</option>
                </select>
            `;
        }
    });
}

function changeTransport(dayIndex, placeIndex, mode) {
    itinerary.days[dayIndex].places[placeIndex].transportMode = mode;
    saveItinerary();
    calculateRoute(dayIndex, placeIndex);
}

// ========== ATUALIZAR MAPA ==========
function updateMap(places) {
    markers.forEach(m => m.setMap(null));
    markers = [];
    if (directionsRenderer) directionsRenderer.setMap(null);

    directionsRenderer = new google.maps.DirectionsRenderer({
        suppressMarkers: true,
        polylineOptions: {
            strokeColor: '#1a4d7a',
            strokeWeight: 4,
            strokeOpacity: 0.6
        }
    });
    directionsRenderer.setMap(map);

    const bounds = new google.maps.LatLngBounds();

    places.forEach((place, index) => {
        const marker = new google.maps.Marker({
            position: { lat: place.lat, lng: place.lng },
            map: map,
            title: place.name,
            label: { text: `${index + 1}`, color: 'white', fontWeight: 'bold' },
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 15,
                fillColor: place.visited ? '#4a8b5c' : '#d4af37',
                fillOpacity: 1,
                strokeColor: '#1a4d7a',
                strokeWeight: 3
            }
        });

        const infoWindow = new google.maps.InfoWindow({
            content: `<div style="padding:10px; max-width:200px;">
                <strong>${place.name}</strong><br>
                <em>${place.time} ‚Ä¢ ${place.duration}min</em><br>
                <small>${place.notes}</small>
            </div>`
        });

        marker.addListener('click', () => infoWindow.open(map, marker));
        markers.push(marker);
        bounds.extend(marker.getPosition());
    });

    // Desenhar rota no mapa
    if (places.length > 1) {
        const waypoints = places.slice(1, -1).map(p => ({
            location: new google.maps.LatLng(p.lat, p.lng),
            stopover: true
        }));

        directionsService.route({
            origin:      { lat: places[0].lat, lng: places[0].lng },
            destination: { lat: places[places.length-1].lat, lng: places[places.length-1].lng },
            waypoints:   waypoints,
            travelMode:  google.maps.TravelMode.WALKING,
            optimizeWaypoints: false
        }, (result, status) => {
            if (status === 'OK') directionsRenderer.setDirections(result);
        });
    }

    if (places.length > 0) map.fitBounds(bounds);
}

// ========== DRAG AND DROP (modo edi√ß√£o) ==========
function setupDragAndDropEdit(dayIndex) {
    setTimeout(() => {
        const container = document.getElementById('editPlacesContainer');
        if (!container) return;
        const items = container.querySelectorAll('.edit-place');

        items.forEach(item => {
            item.addEventListener('dragstart', e => {
                draggedElement = item;
                draggedIndex   = parseInt(item.dataset.index);
                item.classList.add('dragging');
            });
            item.addEventListener('dragend', () => {
                item.classList.remove('dragging');
            });
            item.addEventListener('dragover', e => {
                e.preventDefault();
                const targetIndex = parseInt(item.dataset.index);
                if (draggedIndex !== targetIndex) {
                    const day = itinerary.days[dayIndex];
                    const [moved] = day.places.splice(draggedIndex, 1);
                    day.places.splice(targetIndex, 0, moved);
                    draggedIndex = targetIndex;
                    saveItinerary();
                    showDay(dayIndex);
                }
            });
        });
    }, 300);
}

// ========== A√á√ïES ==========
function toggleEditMode() {
    editMode = !editMode;
    renderDaysNav();
    showDay(currentDay);
}

function concludeEdit() {
    editMode = false;
    renderDaysNav();
    showDay(currentDay);
}

function addNewDay() {
    const newId = itinerary.days.length + 1;
    itinerary.days.push({
        id: newId,
        title: `Dia ${newId}`,
        places: []
    });
    saveItinerary();
    currentDay = itinerary.days.length - 1;
    renderDaysNav();
    showDay(currentDay);
}

function deleteDay(dayIndex) {
    if (itinerary.days.length <= 1) {
        alert('Voc√™ n√£o pode excluir o √∫nico dia do roteiro!');
        return;
    }
    if (confirm(`Excluir o dia "${itinerary.days[dayIndex].title}" e todos os seus locais?`)) {
        itinerary.days.splice(dayIndex, 1);
        // Renumerar ids
        itinerary.days.forEach((day, i) => { day.id = i + 1; });
        saveItinerary();
        currentDay = Math.min(dayIndex, itinerary.days.length - 1);
        renderDaysNav();
        showDay(currentDay);
    }
}

function updateDayTitle(dayIndex, title) {
    itinerary.days[dayIndex].title = title;
    saveItinerary();
    renderDaysNav();
}

function addNewPlace(dayIndex) {
    itinerary.days[dayIndex].places.push({
        name: "", lat: 41.1579, lng: -8.6291,
        time: "00:00", duration: 60,
        notes: "Adicione informa√ß√µes sobre este local",
        icon: "üìç", visited: false, comments: "", transportMode: "WALKING"
    });
    saveItinerary();
    showDay(dayIndex);
    // Focar no novo campo
    setTimeout(() => {
        const inputs = document.querySelectorAll('[id^="place-name-"]');
        if (inputs.length > 0) {
            const last = inputs[inputs.length - 1];
            last.focus();
            setupAutocomplete(dayIndex, itinerary.days[dayIndex].places.length - 1);
        }
    }, 400);
}

function toggleVisited(dayIndex, placeIndex, visited) {
    itinerary.days[dayIndex].places[placeIndex].visited = visited;
    saveItinerary();
    showDay(currentDay);
}

function updateComments(dayIndex, placeIndex, comments) {
    itinerary.days[dayIndex].places[placeIndex].comments = comments;
    saveItinerary();
}

function updatePlace(dayIndex, placeIndex, field, value) {
    itinerary.days[dayIndex].places[placeIndex][field] = value;
    saveItinerary();
}

function deletePlace(dayIndex, placeIndex) {
    if (confirm('Tem certeza que deseja remover este local?')) {
        itinerary.days[dayIndex].places.splice(placeIndex, 1);
        if (!itinerary.days[dayIndex].places) {
            itinerary.days[dayIndex].places = [];
        }
        saveItinerary();
        showDay(dayIndex);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Inicializa√ß√£o acontece no itineraryRef.on e initMap
});

    </script>

    <!-- CSS para rotas e transporte -->
    <style>
        .route-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            background: linear-gradient(135deg, #f0f7ff 0%, #e8f4ff 100%);
            border-left: 3px solid var(--porto-blue);
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            border-radius: 0 8px 8px 0;
            font-size: 0.85rem;
        }
        
        .route-details {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .route-distance {
            font-weight: 600;
            color: var(--porto-blue);
        }
        
        .route-duration {
            color: var(--porto-stone);
        }
        
        .route-loading {
            color: var(--porto-stone);
            font-style: italic;
        }
        
        .transport-selector {
            padding: 0.4rem 0.75rem;
            border: 2px solid var(--porto-blue);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 0.85rem;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .transport-selector:focus {
            outline: none;
            border-color: var(--porto-gold);
        }
    </style>

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCRw4Z1V4506xXX88ztcfjK9oR1aQ6Gx3I&libraries=places&callback=initMap"></script>
</body>
</html>
